<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/><meta name="viewport"content="width=device-width,initial-scale=1"/><title>Withdraw - Biluxe10</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>body{font-family:Poppins;background:#071029;color:#e6eef8;margin:0;padding:20px} .box{max-width:600px;margin:20px auto;background:#0b1220;padding:20px;border-radius:12px} input,select{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #223} .btn{background:linear-gradient(90deg,#f59e0b,#ff6b6b);border:none;padding:10px;color:#071029;border-radius:8px;cursor:pointer}</style>
</head>
<body>
<div class="box">
  <h2>Request Withdrawal</h2>
  <div class="small">Enter amount and select payout method</div>
  <input id="amount" type="number" placeholder="Amount (₹)" />
  <select id="method"><option value="UPI">UPI</option><option value="Bank">Bank</option><option value="Crypto">Crypto</option></select>
  <input id="upi" placeholder="UPI ID (if UPI)" />
  <input id="acc" placeholder="Account Number (if Bank)" />
  <input id="ifsc" placeholder="IFSC (if Bank)" />
  <input id="crypto" placeholder="Crypto Address (if Crypto)" />
  <button id="req" class="btn">Submit Request</button>
  <div id="msg" style="margin-top:10px;color:#98a0b3"></div>

  <h3 style="margin-top:18px">Your Requests</h3>
  <ul id="list" style="margin-top:8px"></ul>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

const amountEl = document.getElementById('amount'), methodEl = document.getElementById('method'), upiEl=document.getElementById('upi'), accEl=document.getElementById('acc'), ifscEl=document.getElementById('ifsc'), cryptoEl=document.getElementById('crypto'), reqBtn=document.getElementById('req'), msg=document.getElementById('msg'), list=document.getElementById('list');

onAuthStateChanged(auth, async user=>{
  if(!user) { location.href='auth.html'; return; }
  loadRequests(user.uid);
});

async function loadRequests(uid){
  list.innerHTML = '';
  const q = query(collection(db,'withdrawal'), where('userId','==', uid), orderBy('requestedAt','desc'));
  const snap = await getDocs(q);
  snap.forEach(d=>{
    const v = d.data();
    const li = document.createElement('li');
    li.innerHTML = `₹${Number(v.amount).toLocaleString('en-IN')} • ${v.method} • ${v.status||'pending'}`;
    list.appendChild(li);
  });
}

reqBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if(!user) { location.href='auth.html'; return; }
  const uid = user.uid;
  const amount = Number(amountEl.value);
  const method = methodEl.value;
  if(!amount || amount <= 0){ msg.textContent='Enter valid amount'; return; }
  const payload = { userId: uid, amount, method, status:'pending', requestedAt: new Date() };
  if(method === 'UPI') payload.upiId = upiEl.value.trim();
  if(method === 'Bank'){ payload.accountNumber = accEl.value.trim(); payload.ifsc = ifscEl.value.trim(); }
  if(method === 'Crypto') payload.cryptoAddress = cryptoEl.value.trim();
  try{
    await addDoc(collection(db,'withdrawal'), payload);
    msg.textContent = 'Request submitted. Admin will process soon.';
    amountEl.value = ''; upiEl.value=''; accEl.value=''; ifscEl.value=''; cryptoEl.value='';
    loadRequests(uid);
  } catch(err){ console.error(err); msg.textContent = 'Failed: '+err.message; }
});
</script>
</body>
</html>
