<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biluxe10 | Login & Signup</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ... (Previous CSS remains exactly the same until .referral-banner) ... */
        
        .referral-banner {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            padding: 1.2rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
            animation: pulse-glow 2s infinite;
        }
        
        /* Add new bonus package section */
        .bonus-packages {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .bonus-package {
            background: rgba(255,255,255,0.1);
            padding: 0.75rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .bonus-package:hover {
            transform: translateY(-3px);
            background: rgba(16, 185, 129, 0.1);
            border-color: #10B981;
        }
        
        .bonus-package.selected {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10B981;
        }
        
        .bonus-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #10B981;
            margin-bottom: 0.25rem;
        }
        
        .package-name {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        
        /* Update commission structure for new bonuses */
        .commission-structure {
            background: rgba(255,255,255,0.1);
            padding: 1.2rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .commission-structure h4 {
            text-align: center;
            margin-bottom: 0.75rem;
            color: white;
            font-weight: 600;
        }
        
        .commission-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        .commission-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        /* Mobile Responsive for bonus packages */
        @media (max-width: 768px) {
            .bonus-packages {
                grid-template-columns: 1fr;
            }
        }
        
        /* ... (Rest of the CSS remains exactly the same) ... */
    </style>
</head>
<body>
    <!-- ... (Previous HTML remains exactly the same until commission structure) ... -->
    
    <!-- Referral Banner (Auto-shows when referral link) -->
    <div class="referral-banner hidden" id="referralBanner">
        <i class="fas fa-gift fa-lg mb-2"></i>
        <h3 class="font-bold">üéâ MEGA JOINING BONUS!</h3>
        <p class="mt-1">Get ‚Çπ5,000 to ‚Çπ10,000 Joining Bonus!</p>
        <p class="text-sm mt-1">Referral Code: <strong id="referralCodeDisplay"></strong></p>
    </div>
    
    <!-- Bonus Package Selection -->
    <div class="bonus-packages hidden" id="bonusPackages">
        <div class="bonus-package" data-package="basic" onclick="selectPackage('basic')">
            <div class="bonus-amount">‚Çπ5,000</div>
            <div class="package-name">Basic Package</div>
        </div>
        <div class="bonus-package" data-package="premium" onclick="selectPackage('premium')">
            <div class="bonus-amount">‚Çπ8,000</div>
            <div class="package-name">Premium Package</div>
        </div>
        <div class="bonus-package" data-package="pro" onclick="selectPackage('pro')">
            <div class="bonus-amount">‚Çπ10,000</div>
            <div class="package-name">Pro Package</div>
        </div>
    </div>
    
    <!-- Commission Structure -->
    <div class="commission-structure hidden" id="commissionInfo">
        <h4>üí∞ NEW BONUS STRUCTURE</h4>
        <div class="commission-grid">
            <div class="commission-item">
                <span>Basic Package Bonus:</span>
                <span class="font-bold text-green-400">‚Çπ5,000</span>
            </div>
            <div class="commission-item">
                <span>Premium Package Bonus:</span>
                <span class="font-bold text-yellow-400">‚Çπ8,000</span>
            </div>
            <div class="commission-item">
                <span>Pro Package Bonus:</span>
                <span class="font-bold text-purple-400">‚Çπ10,000</span>
            </div>
            <div class="commission-item">
                <span>Direct Commission:</span>
                <span class="font-bold text-blue-400">50%</span>
            </div>
            <div class="commission-item">
                <span>Team Commission:</span>
                <span class="font-bold text-pink-400">15%</span>
            </div>
        </div>
    </div>
    
    <!-- Signup Form -->
    <div id="signupForm" class="fade-in">
        <h2 class="text-2xl font-bold text-white text-center mb-6">Create Account</h2>
        
        <div class="space-y-4">
            <div class="form-group">
                <input type="text" id="signupName" placeholder="Full Name" class="form-input">
            </div>
            
            <div class="form-group">
                <input type="email" id="signupEmail" placeholder="Email Address" class="form-input">
            </div>
            
            <div class="form-group">
                <input type="password" id="signupPassword" placeholder="Password" class="form-input">
            </div>
            
            <div class="form-group">
                <input type="tel" id="signupPhone" placeholder="Phone Number" class="form-input">
            </div>
            
            <!-- Package Selection (Initially hidden, shows after signup) -->
            <div class="form-group hidden" id="packageSelection">
                <label class="block text-sm font-medium text-gray-300 mb-2">Select Package for Joining Bonus:</label>
                <select id="selectedPackage" class="form-input">
                    <option value="basic">Basic Package (‚Çπ5,000 Bonus)</option>
                    <option value="premium">Premium Package (‚Çπ8,000 Bonus)</option>
                    <option value="pro">Pro Package (‚Çπ10,000 Bonus)</option>
                </select>
            </div>
            
            <div class="form-group">
                <input type="text" id="signupReferral" placeholder="Referral Code (Optional)" class="form-input">
            </div>
            
            <button id="signupBtn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>Create Account & Get Bonus
            </button>
        </div>
        
        <div class="form-toggle">
            Already have an account? 
            <span class="toggle-link" id="showLogin">Login</span>
        </div>
    </div>
    
    <!-- Login Form -->
    <div id="loginForm" class="hidden">
        <h2 class="text-2xl font-bold text-white text-center mb-6">Welcome Back</h2>
        
        <div class="space-y-4">
            <div class="form-group">
                <input type="email" id="loginEmail" placeholder="Email Address" class="form-input">
            </div>
            
            <div class="form-group">
                <input type="password" id="loginPassword" placeholder="Password" class="form-input">
            </div>
            
            <button id="loginBtn" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i>Login to Dashboard
            </button>
        </div>
        
        <div class="form-toggle">
            Don't have an account? 
            <span class="toggle-link" id="showSignup">Sign Up for ‚Çπ5,000-10,000 Bonus</span>
        </div>
    </div>
    
    <!-- Loading State -->
    <div class="loading-spinner" id="loadingState">
        <div class="spinner"></div>
        <p class="text-white mt-2">Processing...</p>
    </div>
    
    <!-- Alert Messages -->
    <div class="alert-message" id="alertMessage"></div>
</div>
</div>
</div>

<script>
// Create floating particles
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const size = Math.random() * 4 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.animationDelay = `${Math.random() * 15}s`;
        particle.style.animationDuration = `${10 + Math.random() * 10}s`;
        particlesContainer.appendChild(particle);
    }
}

createParticles();

// Package selection variable
let selectedPackage = 'basic'; // Default to basic

// Package selection function
function selectPackage(packageType) {
    selectedPackage = packageType;
    
    // Update UI
    document.querySelectorAll('.bonus-package').forEach(pkg => {
        pkg.classList.remove('selected');
    });
    document.querySelector(`[data-package="${packageType}"]`).classList.add('selected');
    
    // Update selected package in form
    document.getElementById('selectedPackage').value = packageType;
}

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDxxkC9iD1V1w-53Kf4oBrHEXlBLvCc7sE",
    authDomain: "biluxe10-3e894.firebaseapp.com",
    projectId: "biluxe10-3e894",
    storageBucket: "biluxe10-3e894.firebasestorage.app",
    messagingSenderId: "804749588233",
    appId: "1:804749588233:web:7777648c0c7834733c05d8"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM Elements
const signupForm = document.getElementById('signupForm');
const loginForm = document.getElementById('loginForm');
const loadingState = document.getElementById('loadingState');
const alertMessage = document.getElementById('alertMessage');
const authCard = document.getElementById('authCard');
const referralBanner = document.getElementById('referralBanner');
const commissionInfo = document.getElementById('commissionInfo');
const referralCodeDisplay = document.getElementById('referralCodeDisplay');
const bonusPackages = document.getElementById('bonusPackages');
const packageSelection = document.getElementById('packageSelection');

// Check for referral code in URL - AUTO SWITCH TO SIGNUP
const urlParams = new URLSearchParams(window.location.search);
const referralCodeFromURL = urlParams.get('ref');

// AUTO SHOW SIGNUP FORM IF REFERRAL LINK
if (referralCodeFromURL) {
    showSignupForm();
    showReferralBanners(referralCodeFromURL);
}

// Form Toggle Functions
document.getElementById('showLogin').addEventListener('click', showLoginForm);
document.getElementById('showSignup').addEventListener('click', showSignupForm);

function showLoginForm() {
    signupForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
    loginForm.classList.add('fade-in');
    hideReferralBanners();
}

function showSignupForm() {
    loginForm.classList.add('hidden');
    signupForm.classList.remove('hidden');
    signupForm.classList.add('signup-animation');
    if (referralCodeFromURL) {
        showReferralBanners(referralCodeFromURL);
    }
}

function showReferralBanners(code) {
    referralBanner.classList.remove('hidden');
    commissionInfo.classList.remove('hidden');
    bonusPackages.classList.remove('hidden');
    packageSelection.classList.remove('hidden');
    document.getElementById('signupReferral').value = code;
    referralCodeDisplay.textContent = code;
}

function hideReferralBanners() {
    referralBanner.classList.add('hidden');
    commissionInfo.classList.add('hidden');
    bonusPackages.classList.add('hidden');
    packageSelection.classList.add('hidden');
}

// Show/Hide Loading
function showLoading() {
    loadingState.style.display = 'block';
}

function hideLoading() {
    loadingState.style.display = 'none';
}

// Show Alert Message
function showAlert(message, type = 'success') {
    alertMessage.textContent = message;
    alertMessage.className = `alert-message alert-${type}`;
    alertMessage.style.display = 'block';
    setTimeout(() => {
        alertMessage.style.display = 'none';
    }, 5000);
}

// Generate Referral Code
function generateReferralCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = 'BLX10';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// Calculate joining bonus based on package
function calculateJoiningBonus(packageType) {
    const bonuses = {
        'basic': 5000,
        'premium': 8000,
        'pro': 10000
    };
    return bonuses[packageType] || 5000;
}

// Handle Referral System with NEW BONUSES
async function handleReferralSystem(newUserId, referralCode, userData, selectedPackage) {
    try {
        // Calculate joining bonus
        const joiningBonus = calculateJoiningBonus(selectedPackage);
        
        // Find referrer by referral code
        const usersSnapshot = await db.collection("user_collections").get();
        let referrerId = null;
        let referrerData = null;

        usersSnapshot.forEach((doc) => {
            const user = doc.data();
            if (user.referralCode === referralCode) {
                referrerId = doc.id;
                referrerData = user;
            }
        });

        if (referrerId && referrerData) {
            console.log("üéØ Referral found:", referrerData.email);

            // Add referredBy to new user
            userData.referredBy = referrerId;

            // Create referral relationship
            await db.collection("referrals").doc(`${referrerId}_${newUserId}`).set({
                referrerId: referrerId,
                referredId: newUserId,
                referralCode: referralCode,
                joinDate: new Date(),
                status: 'active',
                level: 1,
                earnedCommission: 0
            });

            // Update referrer's counts
            await db.collection("user_collections").doc(referrerId).update({
                referralCount: firebase.firestore.FieldValue.increment(1),
                teamCount: firebase.firestore.FieldValue.increment(1),
                activeTeamCount: firebase.firestore.FieldValue.increment(1)
            }); 

            // Give MEGA joining bonus to new user based on package
            await db.collection("user_collections").doc(newUserId).update({
                balance: firebase.firestore.FieldValue.increment(joiningBonus),
                availableBalance: firebase.firestore.FieldValue.increment(joiningBonus),
                totalEarnings: firebase.firestore.FieldValue.increment(joiningBonus),
                bonusEarnings: firebase.firestore.FieldValue.increment(joiningBonus),
                packageLevel: selectedPackage
            });

            // Record MEGA joining bonus transaction for new user
            await db.collection("transactions").doc(`${newUserId}_${Date.now()}`).set({
                userId: newUserId,
                type: 'joining_bonus',
                amount: joiningBonus,
                description: `‚Çπ${joiningBonus} Joining Bonus (${selectedPackage} package)`,
                status: 'completed',
                timestamp: new Date()
            });

            // Calculate referrer bonus (10% of joining bonus)
            const referrerBonus = joiningBonus * 0.10;

            // Give bonus to referrer
            await db.collection("user_collections").doc(referrerId).update({
                balance: firebase.firestore.FieldValue.increment(referrerBonus),
                totalEarnings: firebase.firestore.FieldValue.increment(referrerBonus),
                referralEarnings: firebase.firestore.FieldValue.increment(referrerBonus)
            });

            // Record commission for referrer
            await db.collection("transactions").doc(`${referrerId}_${Date.now()}`).set({
                userId: referrerId,
                type: 'referral_bonus',
                amount: referrerBonus,
                description: `‚Çπ${referrerBonus} Referral Bonus from ${userData.username}`,
                status: 'completed',
                timestamp: new Date()
            });

            console.log(`‚úÖ Referral system processed successfully. Joining Bonus: ‚Çπ${joiningBonus}, Referrer Bonus: ‚Çπ${referrerBonus}`);
            return { success: true, joiningBonus: joiningBonus, referrerBonus: referrerBonus };
        } else {
            console.log("‚ùå Referral code not found:", referralCode);
            return { success: false, joiningBonus: joiningBonus };
        }
    } catch (error) {
        console.error("‚ùå Error in referral system:", error);
        return { success: false, error: error };
    }
}

// SIGNUP Function with NEW BONUS SYSTEM
document.getElementById('signupBtn').addEventListener('click', handleSignup);

// LOGIN Function
document.getElementById('loginBtn').addEventListener('click', handleLogin);

async function handleSignup() {
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const phone = document.getElementById('signupPhone').value.trim();
    const referral = document.getElementById('signupReferral').value.trim();
    const packageType = document.getElementById('selectedPackage').value;

    if (!name || !email || !password || !phone) {
        showAlert('Please fill in all fields', 'error');
        return;
    }

    if (password.length < 6) {
        showAlert('Password must be at least 6 characters', 'error');
        return;
    }

    showLoading();

    try {
        // Create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Get referral code (from URL or input)
        const referralCode = referralCodeFromURL || referral;
        const username = email.split('@')[0];
        
        // Calculate joining bonus
        const joiningBonus = calculateJoiningBonus(packageType);

        // Create user data with ALL REQUIRED FIELDS for dashboard
        const userData = {
            // BASIC INFO
            userId: user.uid,
            email: email,
            username: username,
            fullName: name,
            phoneNumber: phone,
            password: password,
            
            // CURRENT BALANCES - START WITH MEGA BONUS
            balance: joiningBonus,
            availableBalance: joiningBonus,
            totalEarnings: joiningBonus,
            
            // REFERRAL SYSTEM
            referralCode: generateReferralCode(),
            referredBy: "", // Will be updated if referral exists
            referralCount: 0,
            teamCount: 0,
            activeTeamCount: 0,
            directReferrals: 0,
            
            // COMMISSION EARNINGS - START WITH 0
            directCommission: 0,
            passiveCommission: 0,
            totalCommission: 0,
            bonusEarnings: joiningBonus, // Track joining bonus
            referralEarnings: 0,
            teamEarnings: 0,
            
            // PACKAGE INFO
            packageLevel: packageType,
            joiningBonus: joiningBonus,
            
            // TIME-BASED EARNINGS - START WITH 0
            weeklyEarnings: 0,
            monthlyEarnings: 0,
            dailyEarnings: 0,
            
            // USER STATUS
            paymentStatus: "pending",
            joinDate: new Date(),
            lastLogin: new Date(),
            isActive: true,
            profilePicture: ""
        };

        // Handle referral system if referral code exists
        let referralResult = { success: false, joiningBonus: joiningBonus };
        if (referralCode) {
            referralResult = await handleReferralSystem(user.uid, referralCode, userData, packageType);
            if (referralResult.success) {
                // Update user data with referral info
                userData.referredBy = referralResult.referredBy;
            }
        }

        // Save user data to Firestore - user_collections ONLY
        await db.collection("user_collections").doc(user.uid).set(userData);

        // Record joining bonus transaction
        await db.collection("transactions").add({
            userId: user.uid,
            type: 'joining_bonus',
            amount: joiningBonus,
            description: `‚Çπ${joiningBonus} Joining Bonus (${packageType} package)`,
            status: 'completed',
            timestamp: new Date()
        });

        // Show success message based on referral
        let successMessage = `üéâ Account created successfully! You received ‚Çπ${joiningBonus} joining bonus! `;
        if (referralResult.success) {
            successMessage += `Plus ‚Çπ${referralResult.referrerBonus} given to your referrer!`;
        }
        successMessage += ` Redirecting to payment...`;
        
        showAlert(successMessage);
        
        // REDIRECT TO products.html (Payment Page)
        setTimeout(() => {
            window.location.href = 'products.html';
        }, 3000);

    } catch (error) {
        console.error('Signup error:', error);
        if (error.code === 'auth/email-already-in-use') {
            showAlert('Email already exists. Please use different email.', 'error');
        } else if (error.code === 'auth/weak-password') {
            showAlert('Password should be at least 6 characters', 'error');
        } else if (error.code === 'auth/invalid-email') {
            showAlert('Invalid email address', 'error');
        } else {
            showAlert('Error creating account: ' + error.message, 'error');
        }
    } finally {
        hideLoading();
    }
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!email || !password) {
        showAlert('Please enter email and password', 'error');
        return;
    }

    showLoading();

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Check user data
        const userDoc = await db.collection("user_collections").doc(user.uid).get();
        
        if (!userDoc.exists) {
            showAlert('User data not found! Please sign up first.', 'error');
            return;
        }

        const userData = userDoc.data();
        const paymentStatus = userData.paymentStatus;

        // Update last login
        await db.collection("user_collections").doc(user.uid).update({
            lastLogin: new Date()
        });

        // CHECK PAYMENT STATUS
        if (paymentStatus === "approved") {
            showAlert('Login successful! Redirecting to dashboard...');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500);
        } else {
            // Check if user has joining bonus
            const joiningBonus = userData.joiningBonus || 0;
            if (joiningBonus > 0) {
                showAlert(`Login successful! You have ‚Çπ${joiningBonus} joining bonus. Complete payment to withdraw!`);
            } else {
                showAlert('Login successful! Please complete payment first.');
            }
            setTimeout(() => {
                window.location.href = 'products.html';
            }, 2000);
        }

    } catch (error) {
        console.error('Login error:', error);
        if (error.code === 'auth/user-not-found') {
            showAlert('No account found with this email', 'error');
        } else if (error.code === 'auth/wrong-password') {
            showAlert('Incorrect password', 'error');
        } else if (error.code === 'auth/invalid-email') {
            showAlert('Invalid email address', 'error');
        } else {
            showAlert('Login failed: ' + error.message, 'error');
        }
    } finally {
        hideLoading();
    }
}

// Enter key support
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        if (!signupForm.classList.contains('hidden')) {
            handleSignup();
        } else {
            handleLogin();
        }
    }
});

// Mobile-friendly touch effects
authCard.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1) {
        const touch = e.touches[0];
        const xAxis = (window.innerWidth / 2 - touch.pageX) / 25;
        const yAxis = (window.innerHeight / 2 - touch.pageY) / 25;
        authCard.style.transform = `rotateY(${xAxis}deg) rotateX(${yAxis}deg)`;
    }
});

authCard.addEventListener('touchend', () => {
    authCard.style.transition = 'all 0.5s ease';
    authCard.style.transform = 'rotateY(0deg) rotateX(0deg)';
});

// Initialize package selection
window.onload = function() {
    // Select default package
    selectPackage('basic');
};
</script>
</body>
  </html>
