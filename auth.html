<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.2, user-scalable=yes">
    <title>BILUXE10 | A4 Â· ELITE AFFILIATE</title>
    
    <!-- COMPACT PREMIUM TYPOGRAPHY -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600&family=Clash+Display:wght@500;600;700&family=Satoshi:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0FBA7A;
            --primary-dark: #0A8C5E;
            --accent: #FFB547;
            --purple: #9D7BFF;
            --pink: #FF6B9D;
            --red: #FF4D4D;
            --glass-bg: rgba(12, 20, 35, 0.75);
            --glass-border: rgba(255,255,255,0.12);
            --font-display: 'Clash Display', sans-serif;
            --font-body: 'Satoshi', sans-serif;
            --font-mono: 'Space Grotesk', monospace;
        }

        body {
            background: radial-gradient(circle at 20% 30%, #0B0F18, #070B12);
            font-family: var(--font-body);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1.2rem;
            position: relative;
        }

        /* COSMIC BG â€“ subtle */
        .cosmic-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(90px);
            opacity: 0.2;
        }
        .orb-1 { width: 550px; height: 550px; background: #0FBA7A; top: -250px; left: -200px; }
        .orb-2 { width: 450px; height: 450px; background: #9D7BFF; bottom: -250px; right: -200px; }
        .orb-3 { width: 350px; height: 350px; background: #FFB547; top: 40%; left: 60%; }
        .particle-grid {
            position: fixed; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* ---------- A4 OPTIMIZED CARD â€“ MINIMAL SCROLL, MAX DENSITY ---------- */
        .premium-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .glass-card {
            max-width: 760px;      /* perfect for A4 proportions */
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            border-radius: 36px;
            padding: 1.8rem 2rem;
            box-shadow: 0 30px 50px -20px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.05) inset;
            position: relative;
            transition: all 0.2s;
        }

        /* COMPACT LOGO */
        .logo-3d {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .logo-icon {
            width: 58px;
            height: 58px;
            background: linear-gradient(145deg, #0FBA7A, #0A8C5E, #FFB547);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 12px 25px rgba(15,186,122,0.5);
            transform: rotateX(6deg) rotateY(8deg);
        }
        .logo-text {
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #e2e8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }
        .logo-sub {
            font-size: 0.68rem;
            letter-spacing: 0.3em;
            color: rgba(255,255,255,0.55);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* ------ PACKAGE GRID â€“ 9 CARDS, THEMED NAMES, ULTRA COMPACT ------ */
        .package-section {
            margin-bottom: 1.3rem;
        }
        .package-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.55rem;
            margin-bottom: 0.55rem;
        }
        .package-grid-bottom {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.55rem;
        }

        .package-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 0.9rem 0.2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.2, 0.9, 0.4, 1);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            position: relative;
        }

        .package-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            background: rgba(15,186,122,0.1);
            box-shadow: 0 8px 18px rgba(15,186,122,0.2);
        }

        .package-card.selected {
            background: linear-gradient(145deg, rgba(15,186,122,0.2), rgba(10,140,94,0.15));
            border: 1.8px solid var(--primary);
            box-shadow: 0 0 0 3px rgba(15,186,122,0.2);
        }
        .package-card.selected::after {
            content: "âœ“";
            position: absolute;
            top: 5px;
            right: 7px;
            color: var(--primary);
            font-weight: 900;
            font-size: 1rem;
            background: rgba(0,0,0,0.3);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--primary);
        }

        /* PACKAGE NAMES â€“ TIERED LUXURY */
        .package-tier {
            font-family: var(--font-display);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: rgba(255,255,255,0.05);
            padding: 0.2rem 0.6rem;
            border-radius: 30px;
            color: rgba(255,255,255,0.9);
            border: 0.5px solid rgba(255,255,255,0.1);
        }
        .package-amount {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #d6e0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        .package-bonus {
            font-size: 0.6rem;
            background: rgba(255,181,71,0.15);
            color: var(--accent);
            padding: 0.2rem 0.6rem;
            border-radius: 40px;
            border: 0.5px solid rgba(255,181,71,0.3);
            font-weight: 700;
            white-space: nowrap;
        }

        /* BONUS BANNER â€“ SLIMMER */
        .bonus-banner {
            background: linear-gradient(145deg, rgba(15,186,122,0.15), rgba(255,181,71,0.12));
            border-radius: 24px;
            padding: 1rem 1.5rem;
            margin: 1.2rem 0 1.2rem;
            border: 1px solid rgba(255,181,71,0.25);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .bonus-title {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .bonus-amount {
            font-size: 1.7rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* FORM â€“ COMPACT GRID */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 0.8rem;
        }
        .form-group {
            position: relative;
            width: 100%;
        }
        .form-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.45);
            font-size: 0.9rem;
            z-index: 2;
        }
        .premium-input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 2.6rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            backdrop-filter: blur(5px);
            transition: 0.2s;
        }
        .premium-input:focus {
            border-color: var(--primary);
            background: rgba(15,186,122,0.1);
            box-shadow: 0 0 0 3px rgba(15,186,122,0.1);
            outline: none;
        }
        .premium-input::placeholder {
            color: rgba(255,255,255,0.4);
            font-weight: 300;
            font-size: 0.8rem;
        }

        /* SELECTED PACKAGE INFO â€“ COMPACT */
        .selected-info {
            background: rgba(255,255,255,0.02);
            border-radius: 18px;
            padding: 0.8rem 1.2rem;
            margin: 1rem 0 1rem;
            display: flex;
            justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }
        .selected-tag {
            background: rgba(15,186,122,0.18);
            padding: 0.35rem 1rem;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 3D BUTTON â€“ DENSE */
        .btn-3d {
            width: 100%;
            padding: 1rem;
            border-radius: 26px;
            border: none;
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.1em;
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 12px 22px -8px rgba(15,186,122,0.5);
            transition: 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            cursor: pointer;
        }
        .btn-3d:hover { transform: translateY(-3px); box-shadow: 0 18px 30px -8px rgba(15,186,122,0.7); }

        /* REFERRAL BADGE â€“ TIDY */
        .referral-badge {
            background: rgba(157,123,255,0.12);
            border-radius: 18px;
            padding: 0.9rem 1.2rem;
            margin-bottom: 1.2rem;
            border: 1px solid rgba(157,123,255,0.25);
            display: none;
        }
        .referral-code {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--purple);
        }

        /* TOGGLE + ALERTS */
        .form-toggle {
            margin-top: 1.4rem;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        .toggle-link {
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            background: rgba(15,186,122,0.1);
            padding: 0.3rem 1.1rem;
            border-radius: 50px;
            margin-left: 0.6rem;
        }
        .alert-3d {
            margin-top: 1.2rem;
            border-radius: 18px;
            padding: 0.9rem;
            display: none;
        }
        .loading-3d {
            padding: 0.9rem;
            text-align: center;
        }
        .spinner-3d {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 0.5rem;
        }

        .hidden { display: none !important; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* A4 â€“ no almost no scroll: height fixed */
        @media (max-width: 750px) {
            .glass-card { padding: 1.5rem; }
            .package-grid { grid-template-columns: repeat(3, 1fr); }
            .package-grid-bottom { grid-template-columns: repeat(3, 1fr); }
            .form-row { grid-template-columns: 1fr; }
        }

        /* PASSWORD ADDED â€“ visible field, full logic unchanged */
    </style>
</head>
<body>
    <div class="cosmic-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="particle-grid"></div>
    </div>

    <div class="premium-container">
        <div class="glass-card">
            <!-- LOGO â€“ compact left aligned -->
            <div class="logo-3d">
                <div class="logo-icon"><i class="fas fa-crown"></i></div>
                <div>
                    <div class="logo-text">BILUXE10</div>
                    <div class="logo-sub">AFFILIATE ELITE</div>
                </div>
            </div>

            <!-- JOIN STEPS ultra slim -->
            <div id="signupGuide" style="display: flex; gap: 0.6rem; align-items: center; background: rgba(255,255,255,0.02); padding: 0.7rem 1.2rem; border-radius: 40px; margin-bottom: 1rem;">
                <i class="fas fa-bolt" style="color: var(--primary);"></i>
                <span style="font-size: 0.75rem; letter-spacing: 0.1em;">1.FILL 2.PACKAGE 3.PAY 4.EARN</span>
            </div>

            <!-- ========== PACKAGE GRID â€“ 9 CARDS WITH NAMES ========= -->
            <div class="package-section">
                <!-- TOP ROW â€“ 5 CARDS (â‚¹250, â‚¹499, â‚¹1299, â‚¹2499, â‚¹3499) -->
                <div class="package-grid">
                    <div class="package-card" onclick="selectPackage(this)" data-amount="250" data-bonus="500" data-tier="BRONZE">
                        <span class="package-tier">BRONZE</span>
                        <span class="package-amount">â‚¹250</span>
                        <span class="package-bonus">+â‚¹500</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="499" data-bonus="800" data-tier="SILVER">
                        <span class="package-tier">SILVER</span>
                        <span class="package-amount">â‚¹499</span>
                        <span class="package-bonus">+â‚¹800</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="1299" data-bonus="2000" data-tier="GOLD">
                        <span class="package-tier">GOLD</span>
                        <span class="package-amount">â‚¹1,299</span>
                        <span class="package-bonus">+â‚¹2,000</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="2499" data-bonus="3000" data-tier="PLATINUM">
                        <span class="package-tier">PLATINUM</span>
                        <span class="package-amount">â‚¹2,499</span>
                        <span class="package-bonus">+â‚¹3,000</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="3499" data-bonus="4000" data-tier="TITANIUM">
                        <span class="package-tier">TITANIUM</span>
                        <span class="package-amount">â‚¹3,499</span>
                        <span class="package-bonus">+â‚¹4,000</span>
                    </div>
                </div>
                <!-- BOTTOM ROW â€“ 4 CARDS (â‚¹4999, â‚¹9999, â‚¹15999, â‚¹23999) -->
                <div class="package-grid-bottom">
                    <div class="package-card" onclick="selectPackage(this)" data-amount="4999" data-bonus="5000" data-tier="RUBY">
                        <span class="package-tier">RUBY</span>
                        <span class="package-amount">â‚¹4,999</span>
                        <span class="package-bonus">+â‚¹5,000</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="9999" data-bonus="5500" data-tier="EMERALD">
                        <span class="package-tier">EMERALD</span>
                        <span class="package-amount">â‚¹9,999</span>
                        <span class="package-bonus">+â‚¹5,500</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="15999" data-bonus="7000" data-tier="DIAMOND">
                        <span class="package-tier">DIAMOND</span>
                        <span class="package-amount">â‚¹15,999</span>
                        <span class="package-bonus">+â‚¹7,000</span>
                    </div>
                    <div class="package-card" onclick="selectPackage(this)" data-amount="23999" data-bonus="8000" data-tier="BLACK">
                        <span class="package-tier">BLACK</span>
                        <span class="package-amount">â‚¹23,999</span>
                        <span class="package-bonus">+â‚¹8,000</span>
                    </div>
                </div>
            </div>

            <!-- BONUS BANNER slim -->
            <div id="bonusBanner" class="bonus-banner">
                <span class="bonus-title"><i class="fas fa-gem"></i> JOIN BONUS</span>
                <span class="bonus-amount" id="dynamicBonusDisplay">â‚¹500 â€“ â‚¹8,000</span>
            </div>

            <!-- REFERRAL BADGE (hidden by default) -->
            <div id="referralBadge" class="referral-badge">
                <i class="fas fa-user-friends" style="color: var(--purple);"></i>
                <span style="font-weight: 700; margin-right: 10px;">REF:</span>
                <span id="referralCodeDisplay" class="referral-code">BLX10XXXXXX</span>
            </div>

            <!-- ========== SIGNUP FORM ========= -->
            <div id="signupFormContainer" class="premium-form">
                <!-- 2-COLUMN FORM for compact A4 -->
                <div class="form-row">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="signupFullName" class="premium-input" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="signupEmail" class="premium-input" placeholder="Email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupPassword" class="premium-input" placeholder="Password (min 6)">
                    </div>
                    <div class="form-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="signupPhone" class="premium-input" placeholder="Phone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <i class="fas fa-gift"></i>
                        <input type="text" id="signupReferralCode" class="premium-input" placeholder="Referral (optional)" readonly>
                    </div>
                    <!-- added extra password confirmation? not needed, but we keep clean -->
                    <div class="form-group">
                        <i class="fas fa-shield-alt"></i>
                        <input type="password" id="signupConfirmPassword" class="premium-input" placeholder="Confirm password">
                    </div>
                </div>

                <!-- Selected package info + tier name -->
                <div id="selectedPackageInfo" class="selected-info">
                    <span class="selected-tag">
                        <i class="fas fa-crown"></i> <span id="displayPackageTier">BRONZE</span> Â· <span id="displayPackageAmount">â‚¹250</span>
                    </span>
                    <span class="selected-tag" style="background: rgba(255,181,71,0.15);">
                        <i class="fas fa-gift"></i> BONUS <span id="displayBonusAmount">â‚¹500</span>
                    </span>
                </div>

                <button id="signupBtn" class="btn-3d">
                    <i class="fas fa-user-plus"></i> CREATE & CONTINUE
                </button>
            </div>

            <!-- ========== LOGIN FORM (hidden by default) ========= -->
            <div id="loginFormContainer" class="premium-form hidden">
                <div style="margin-bottom: 1rem;">
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="loginEmail" class="premium-input" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" class="premium-input" placeholder="Password">
                    </div>
                    <!-- added password field (login already had password) -->
                </div>
                <button id="loginBtn" class="btn-3d">
                    <i class="fas fa-sign-in-alt"></i> LOGIN
                </button>
            </div>

            <!-- TOGGLE SIGNUP / LOGIN -->
            <div class="form-toggle">
                <span id="toggleMessage">Already have an account?</span>
                <span id="toggleButton" class="toggle-link">Login</span>
            </div>

            <!-- LOADING & ALERT -->
            <div id="loadingSpinner" class="loading-3d hidden">
                <div class="spinner-3d"></div>
                <p style="font-size:0.8rem;">processing..</p>
            </div>
            <div id="alertMessage" class="alert-3d"></div>
        </div>
    </div>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDxxkC9iD1V1w-53Kf4oBrHEXlBLvCc7sE",
            authDomain: "biluxe10-3e894.firebaseapp.com",
            projectId: "biluxe10-3e894",
            storageBucket: "biluxe10-3e894.firebasestorage.app",
            messagingSenderId: "804749588233",
            appId: "1:804749588233:web:7777648c0c7834733c05d8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ---------- GLOBALS ----------
        let isLoginMode = false;
        let selectedPackageAmount = 250;
        let selectedPackageBonus = 500;
        let selectedPackageTier = 'BRONZE';

        const urlParams = new URLSearchParams(window.location.search);
        const referralCodeFromUrl = urlParams.get('ref');

        // ---------- EMAIL ID NORMALIZER ----------
        function getEmailId(email) {
            return email.toLowerCase().replace(/\./g, '_');
        }

        // ---------- SELECT PACKAGE (INCLUDES TIER) ----------
        window.selectPackage = function(element) {
            document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            
            selectedPackageAmount = parseInt(element.dataset.amount);
            selectedPackageBonus = parseInt(element.dataset.bonus);
            selectedPackageTier = element.dataset.tier || 'BRONZE';
            
            document.getElementById('displayPackageAmount').innerHTML = 'â‚¹' + selectedPackageAmount.toLocaleString();
            document.getElementById('displayBonusAmount').innerHTML = 'â‚¹' + selectedPackageBonus.toLocaleString();
            document.getElementById('displayPackageTier').innerHTML = selectedPackageTier;
            document.getElementById('dynamicBonusDisplay').innerHTML = `â‚¹${selectedPackageBonus} â€“ â‚¹8,000`; 
        };

        // ---------- AUTO SELECT FIRST PACKAGE (BRONZE) ----------
        document.addEventListener('DOMContentLoaded', function() {
            const firstCard = document.querySelector('.package-card');
            if (firstCard) window.selectPackage(firstCard);
            
            if (referralCodeFromUrl) {
                document.getElementById('referralBadge').style.display = 'flex';
                document.getElementById('referralCodeDisplay').textContent = referralCodeFromUrl;
                document.getElementById('signupReferralCode').value = referralCodeFromUrl;
            }
        });

        // ---------- TOGGLE SIGNUP/LOGIN ----------
        document.getElementById('toggleButton').addEventListener('click', function() {
            isLoginMode = !isLoginMode;
            const signup = document.getElementById('signupFormContainer');
            const login = document.getElementById('loginFormContainer');
            const guide = document.getElementById('signupGuide');
            const bonus = document.getElementById('bonusBanner');
            const packageTop = document.querySelector('.package-section');
            const toggleMsg = document.getElementById('toggleMessage');
            const toggleBtn = document.getElementById('toggleButton');
            
            if (isLoginMode) {
                signup.classList.add('hidden');
                login.classList.remove('hidden');
                guide.classList.add('hidden');
                bonus.classList.add('hidden');
                packageTop.classList.add('hidden');
                toggleMsg.textContent = "Don't have an account?";
                toggleBtn.textContent = "Sign Up";
            } else {
                signup.classList.remove('hidden');
                login.classList.add('hidden');
                guide.classList.remove('hidden');
                bonus.classList.remove('hidden');
                packageTop.classList.remove('hidden');
                toggleMsg.textContent = "Already have an account?";
                toggleBtn.textContent = "Login";
            }
        });

        // UI helpers
        function showLoading() { document.getElementById('loadingSpinner').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingSpinner').classList.add('hidden'); }
        function showAlert(msg, type) {
            const a = document.getElementById('alertMessage');
            a.textContent = msg;
            a.className = 'alert-3d ' + (type === 'success' ? 'alert-success' : 'alert-error');
            a.style.display = 'block';
            setTimeout(() => a.style.display = 'none', 4500);
        }

        // ---------- GENERATE REFERRAL CODE ----------
        function generateReferralCode(emailId) {
            return 'BLX' + emailId.slice(0,4).toUpperCase() + Date.now().toString().slice(-5) + Math.floor(Math.random()*100);
        }

        // ---------- FIND REFERRER ----------
        async function findReferrerByCode(code) {
            const snap = await db.collection('user_collections').where('referralCode', '==', code).limit(1).get();
            return snap.empty ? null : { emailId: snap.docs[0].id, data: snap.docs[0].data() };
        }

        // ---------- CREATE TRANSACTION ----------
        async function createTransaction(userEmailId, type, amount, desc, status='completed', meta={}) {
            await db.collection('transactions').add({ userId: userEmailId, type, amount, description: desc, status, timestamp: firebase.firestore.FieldValue.serverTimestamp(), ...meta });
        }

        // ---------- UPDATE REFERRER STATS (intact) ----------
        async function updateReferrerStats(referrerEmailId, bonusAmount) {
            try {
                const referrerRef = db.collection('user_collections').doc(referrerEmailId);
                const referralsSnap = await db.collection('user_collections').where('referredBy', '==', referrerEmailId).get();
                const totalReferrals = referralsSnap.size;
                const approvedReferrals = referralsSnap.docs.filter(d => d.data().paymentStatus === 'approved').length;
                await referrerRef.update({
                    referralCount: totalReferrals,
                    teamCount: approvedReferrals,
                    referralEarnings: firebase.firestore.FieldValue.increment(bonusAmount),
                    totalEarnings: firebase.firestore.FieldValue.increment(bonusAmount),
                    balance: firebase.firestore.FieldValue.increment(bonusAmount),
                });
                if (bonusAmount > 0) await createTransaction(referrerEmailId, 'commission', bonusAmount, 'Direct commission from referral');
            } catch (e) { console.error(e); }
        }

        // ---------- SIGNUP (with confirm password check) ----------
        document.getElementById('signupBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            const fullName = document.getElementById('signupFullName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const confirm = document.getElementById('signupConfirmPassword').value.trim();
            const referralCode = document.getElementById('signupReferralCode').value.trim();

            if (!fullName || !email || !password || !phone || !confirm) {
                showAlert('All fields required', 'error'); return;
            }
            if (password.length < 6) { showAlert('Password min 6 chars', 'error'); return; }
            if (password !== confirm) { showAlert('Passwords do not match', 'error'); return; }

            showLoading();
            try {
                const userCred = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCred.user;
                const emailId = getEmailId(email);
                const username = email.split('@')[0];
                const userReferralCode = generateReferralCode(emailId);
                
                let referrerEmailId = null, referrerBonus = 0;
                if (referralCode) {
                    const referrer = await findReferrerByCode(referralCode);
                    if (referrer) {
                        referrerEmailId = referrer.emailId;
                        referrerBonus = Math.round(selectedPackageBonus * 0.10);
                    }
                }

                const userData = {
                    userId: user.uid, emailId, email, username, fullName, phoneNumber: phone,
                    selectedPackage: selectedPackageTier,
                    packageAmount: selectedPackageAmount,
                    joiningBonus: selectedPackageBonus,
                    paymentStatus: 'pending',
                    referralCode: userReferralCode,
                    referredBy: referrerEmailId || '',
                    referralCount: 0, teamCount: 0,
                    balance: 0, totalEarnings: 0, dailyEarnings:0, weeklyEarnings:0, monthlyEarnings:0,
                    referralEarnings:0, teamEarnings:0, bonusEarnings:0,
                    pendingWithdrawals:0, totalWithdrawn:0,
                    joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true, accountStatus: 'active'
                };

                const batch = db.batch();
                const userRef = db.collection('user_collections').doc(emailId);
                batch.set(userRef, userData);
                
                const transRef = db.collection('transactions').doc();
                batch.set(transRef, {
                    userId: emailId, type: 'bonus', amount: selectedPackageBonus,
                    description: `Welcome bonus (${selectedPackageTier})`, status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (referrerEmailId) {
                    const refRef = db.collection('referrals').doc();
                    batch.set(refRef, {
                        referrerId: referrerEmailId, referredId: emailId, referralCode,
                        bonusAmount: referrerBonus, status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await batch.commit();
                if (referrerEmailId) updateReferrerStats(referrerEmailId, 0); // fire & forget

                showAlert(`âœ… ${selectedPackageTier} created! Bonus â‚¹${selectedPackageBonus}`, 'success');
                setTimeout(() => window.location.href = `products.html?email=${encodeURIComponent(email)}`, 1800);
            } catch (err) {
                console.error(err);
                if (err.code === 'auth/email-already-in-use') showAlert('Email already registered', 'error');
                else showAlert('Error: ' + err.message, 'error');
                hideLoading();
            }
            hideLoading();
        });

        // ---------- LOGIN (password field already present) ----------
        document.getElementById('loginBtn').addEventListener('click', async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            if (!email || !password) { showAlert('Email & password required', 'error'); return; }
            showLoading();
            try {
                await auth.signInWithEmailAndPassword(email, password);
                const emailId = getEmailId(email);
                await db.collection('user_collections').doc(emailId).update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                showAlert('Login success', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
            } catch (err) {
                showAlert('Login failed: ' + err.message, 'error');
                hideLoading();
            }
        });

        // enter key
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (!document.getElementById('signupFormContainer').classList.contains('hidden')) 
                    document.getElementById('signupBtn').click();
                else 
                    document.getElementById('loginBtn').click();
            }
        });

        console.log('ðŸ”¥ A4 OPTIMIZED â€“ TIER NAMES, PASSWORD CONFIRM, ALL LOGIC KEPT');
    </script>
</body>
</html>
