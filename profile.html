<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biluxe10 - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .page-transition { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .profile-pic { transition: all 0.3s ease; }
        .profile-pic:hover { transform: scale(1.05); }
        .upload-area { border: 2px dashed #d1d5db; transition: all 0.3s ease; }
        .upload-area:hover { border-color: #3b82f6; background-color: #f8fafc; }
        .upload-area.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .status-badge { transition: all 0.3s ease; }
        .status-badge:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Sidebar (Same as dashboard) -->
    <div class="sidebar fixed left-0 top-0 h-full w-64 bg-gradient-to-b from-gray-900 to-black text-white shadow-xl z-50">
        <!-- Same sidebar code -->
    </div>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="flex items-center justify-between h-16 px-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Profile Settings</h2>
                    <p class="text-sm text-gray-600">Manage your account information</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='notifications.html'" class="p-2 text-gray-600 hover:text-gray-900 relative">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notificationBadge" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <div class="flex items-center space-x-3 bg-gray-50 rounded-lg px-3 py-2">
                        <img id="headerProfilePic" src="https://via.placeholder.com/32" alt="Profile" class="w-8 h-8 rounded-full border-2 border-blue-500">
                        <span id="headerUserName" class="text-sm font-medium text-gray-900">User</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Profile Content -->
        <main class="p-6 page-transition">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Profile Picture & Status -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Profile Picture</h3>
                        
                        <!-- Profile Picture -->
                        <div class="flex flex-col items-center space-y-4 mb-6">
                            <div class="relative">
                                <img id="mainProfilePic" src="https://via.placeholder.com/120" alt="Profile" 
                                    class="profile-pic w-32 h-32 rounded-full border-4 border-blue-500 shadow-lg object-cover">
                                <div id="uploadingOverlay" class="hidden absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center">
                                    <div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            </div>

                            <!-- Upload Area -->
                            <div class="upload-area w-full p-4 rounded-lg text-center cursor-pointer" id="uploadArea">
                                <input type="file" id="profileImageInput" accept="image/*" class="hidden">
                                <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Click to upload or drag & drop</p>
                                <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF • Max 5MB</p>
                            </div>

                            <button id="uploadBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 disabled:opacity-50" disabled>
                                <i class="fas fa-upload mr-2"></i>Upload Photo
                            </button>
                        </div>

                        <!-- Account Status -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-900">Account Status</h4>
                            
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">Membership:</span>
                                <span id="membershipStatus" class="status-badge px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">
                                    Loading...
                                </span>
                            </div>

                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">KYC Status:</span>
                                <span id="kycStatus" class="status-badge px-3 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">
                                    Pending
                                </span>
                            </div>

                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">Rank:</span>
                                <span id="rankStatus" class="status-badge px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full">
                                    Loading...
                                </span>
                            </div>

                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">Referral Code:</span>
                                <span id="referralCode" class="status-badge px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full font-mono cursor-pointer" onclick="copyReferralCode()">
                                    Loading...
                                </span>
                            </div>

                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">Join Date:</span>
                                <span id="joinDate" class="text-sm text-gray-900">Loading...</span>
                            </div>

                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">Last Login:</span>
                                <span id="lastLogin" class="text-sm text-gray-900">Loading...</span>
                            </div>

                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">Total Earned:</span>
                                <span id="totalEarned" class="text-sm font-semibold text-green-600">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Personal Information</h3>

                        <form id="profileForm" class="space-y-6">
                            <!-- Basic Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Full Name *
                                    </label>
                                    <input type="text" id="fullName" name="name"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input type="email" id="email" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed"
                                        disabled>
                                    <p class="text-xs text-gray-500 mt-1">Email cannot be changed</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Phone Number
                                    </label>
                                    <input type="tel" id="phone" name="phone"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="+91 XXXXXXXXXX"
                                        pattern="[+][0-9]{2}[0-9]{10}"
                                        title="Please enter a valid phone number with country code">
                                    <p class="text-xs text-gray-500 mt-1">Format: +91XXXXXXXXXX</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Referred By
                                    </label>
                                    <input type="text" id="referredBy"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed"
                                        disabled>
                                </div>
                            </div>

                            <!-- Bank & Payment Details -->
                            <div class="border-t border-gray-200 pt-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Bank & Payment Details</h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Bank Account Number
                                        </label>
                                        <input type="text" id="bankAccount" name="bankAccount"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                            placeholder="Enter account number"
                                            pattern="[0-9]{9,18}"
                                            title="Please enter a valid bank account number">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            IFSC Code
                                        </label>
                                        <input type="text" id="ifscCode" name="ifsc"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                            placeholder="Enter IFSC code"
                                            pattern="[A-Z]{4}0[A-Z0-9]{6}"
                                            title="Please enter a valid IFSC code">
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            UPI ID
                                        </label>
                                        <input type="text" id="upiId" name="upi"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                            placeholder="yourname@upi"
                                            pattern="[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}"
                                            title="Please enter a valid UPI ID">
                                        <p class="text-xs text-gray-500 mt-1">
                                            For instant UPI payments and withdrawals
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- KYC Verification -->
                            <div class="border-t border-gray-200 pt-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">KYC Verification</h4>
                                
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-id-card text-yellow-600 text-xl mt-1"></i>
                                        <div>
                                            <h5 class="font-semibold text-yellow-800 mb-2">Verify Your Identity</h5>
                                            <p class="text-sm text-yellow-700 mb-3">
                                                Complete KYC verification to unlock higher withdrawal limits and full platform access.
                                            </p>
                                            <button type="button" onclick="startKYC()" 
                                                class="bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition-colors">
                                                Start KYC Verification
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Save Button -->
                            <div class="flex space-x-4 pt-6">
                                <button type="submit" id="saveBtn"
                                    class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                                <button type="button" onclick="window.location.href='dashboard.html'"
                                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
                                    Cancel
                                </button>
                            </div>

                            <!-- Saving State -->
                            <div id="savingState" class="hidden p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex items-center justify-center space-x-3">
                                    <div class="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                    <p class="text-blue-800 font-semibold">Saving your changes...</p>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Security Note -->
                    <div class="mt-6 bg-green-50 border border-green-200 rounded-2xl p-6">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-shield-alt text-green-600 text-xl mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-green-800 mb-2">Security Information</h4>
                                <p class="text-sm text-green-700">
                                    Your personal information is securely encrypted and protected. 
                                    We never share your bank details with third parties.
                                </p>
                                <p class="text-xs text-green-600 mt-2">
                                    Last updated: <span id="lastUpdated">Never</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- KYC Modal -->
    <div id="kycModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-900 mb-4">KYC Verification</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Aadhaar Number
                    </label>
                    <input type="text" id="aadhaarNumber" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter 12-digit Aadhaar number"
                        pattern="[0-9]{12}"
                        title="Please enter 12-digit Aadhaar number">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        PAN Number
                    </label>
                    <input type="text" id="panNumber" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter PAN number"
                        pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}"
                        title="Please enter valid PAN number">
                </div>

                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-700">
                        📸 You will need to upload documents after submitting this form.
                    </p>
                </div>
            </div>

            <div class="flex space-x-3 mt-6">
                <button onclick="closeKYCModal()" class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="submitKYC()" class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700">
                    Submit KYC
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase & Profile Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDxxkC9iD1V1w-53Kf4oBrHEXlBLvCc7sE",
            authDomain: "biluxe10-3e894.firebaseapp.com",
            projectId: "biluxe10-3e894",
            storageBucket: "biluxe10-3e894.firebasestorage.app",
            messagingSenderId: "804749588233",
            appId: "1:804749588233:web:7777648c0c7834733c05d8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let currentUser = null;
        let userData = null;
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            setupUpload();
            setupForm();
        });

        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    loadNotifications(user.uid);
                } else {
                    window.location.href = 'auth.html';
                }
            });
        }

        function loadUserData(userId) {
            db.collection('users').doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    userData = doc.data();
                    updateProfileUI(userData);
                    calculateTotalEarnings();
                }
            });
        }

        async function calculateTotalEarnings() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('transactions')
                    .where('userId', '==', currentUser.uid)
                    .where('type', 'in', ['earning', 'bonus'])
                    .get();
                
                let totalEarnings = 0;
                snapshot.forEach(doc => {
                    totalEarnings += doc.data().amount;
                });
                
                document.getElementById('totalEarned').textContent = totalEarnings.toLocaleString();
            } catch (error) {
                console.error('Error calculating earnings:', error);
            }
        }

        function setupUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('profileImageInput');
            const uploadBtn = document.getElementById('uploadBtn');

            // Click to select file
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // Upload button
            uploadBtn.addEventListener('click', uploadProfilePicture);
        }

        function handleFileSelect(file) {
            // Validate file
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file (JPG, PNG, GIF)', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('File size must be less than 5MB', 'error');
                return;
            }

            selectedFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('mainProfilePic').src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Enable upload button
            document.getElementById('uploadBtn').disabled = false;
        }

        async function uploadProfilePicture() {
            if (!selectedFile || !currentUser) {
                showToast('Please select a file first', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadingOverlay = document.getElementById('uploadingOverlay');

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            uploadingOverlay.classList.remove('hidden');

            try {
                // Upload to Firebase Storage
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`profile-pictures/${currentUser.uid}`);
                const snapshot = await fileRef.put(selectedFile);
                const downloadURL = await snapshot.ref.getDownloadURL();

                // Update user profile in Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    profilePic: downloadURL,
                    profileUpdatedAt: new Date()
                });

                showToast('Profile picture updated successfully!', 'success');
                selectedFile = null;
                document.getElementById('profileImageInput').value = '';

            } catch (error) {
                console.error('Error uploading image:', error);
                showToast('Error uploading profile picture. Please try again.', 'error');
            } finally {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Photo';
                uploadingOverlay.classList.add('hidden');
            }
        }

        function setupForm() {
            const form = document.getElementById('profileForm');
            form.addEventListener('submit', handleProfileUpdate);

            // Real-time validation
            const inputs = form.querySelectorAll('input[pattern]');
            inputs.forEach(input => {
                input.addEventListener('blur', validateField);
            });
        }

        function validateField(e) {
            const input = e.target;
            const pattern = input.getAttribute('pattern');
            const value = input.value;

            if (value && pattern) {
                const regex = new RegExp(pattern);
                if (!regex.test(value)) {
                    input.classList.add('border-red-500');
                    showToast(`Invalid ${input.name} format`, 'error');
                } else {
                    input.classList.remove('border-red-500');
                }
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();

            const saveBtn = document.getElementById('saveBtn');
            const savingState = document.getElementById('savingState');

            saveBtn.disabled = true;
            savingState.classList.remove('hidden');

            try {
                const formData = {
                    name: document.getElementById('fullName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    bankAccount: document.getElementById('bankAccount').value.trim(),
                    ifsc: document.getElementById('ifscCode').value.trim().toUpperCase(),
                    upi: document.getElementById('upiId').value.trim(),
                    updatedAt: new Date()
                };

                // Validate required fields
                if (!formData.name) {
                    throw new Error('Full name is required');
                }

                // Update user data in Firestore
                await db.collection('users').doc(currentUser.uid).update(formData);

                // Update last updated timestamp
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

                savingState.innerHTML = `
                    <div class="flex items-center justify-center space-x-3">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        <p class="text-green-800 font-semibold">Changes saved successfully!</p>
                    </div>
                `;

                // Update UI
                updateUserUI({...userData, ...formData});

                setTimeout(() => {
                    savingState.classList.add('hidden');
                    savingState.innerHTML = `
                        <div class="flex items-center justify-center space-x-3">
                            <div class="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                            <p class="text-blue-800 font-semibold">Saving your changes...</p>
                        </div>
                    `;
                }, 2000);

            } catch (error) {
                console.error('Error updating profile:', error);
                showToast(error.message || 'Error updating profile. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                setTimeout(() => savingState.classList.add('hidden'), 2000);
            }
        }

        function startKYC() {
            document.getElementById('kycModal').classList.remove('hidden');
        }

        function closeKYCModal() {
            document.getElementById('kycModal').classList.add('hidden');
        }

        async function submitKYC() {
            const aadhaar = document.getElementById('aadhaarNumber').value;
            const pan = document.getElementById('panNumber').value;

            if (!aadhaar || !pan) {
                showToast('Please fill all KYC fields', 'error');
                return;
            }

            try {
                await db.collection('kyc_verifications').add({
                    userId: currentUser.uid,
                    aadhaarNumber: aadhaar,
                    panNumber: pan,
                    status: 'pending',
                    submittedAt: new Date()
                });

                // Update user KYC status
                await db.collection('users').doc(currentUser.uid).update({
                    kycStatus: 'pending'
                });

                showToast('KYC submitted successfully! We will verify your documents soon.', 'success');
                closeKYCModal();

                // Update KYC status in UI
                document.getElementById('kycStatus').textContent = 'pending';
                document.getElementById('kycStatus').className = 'status-badge px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full';

            } catch (error) {
                console.error('Error submitting KYC:', error);
                showToast('Error submitting KYC. Please try again.', 'error');
            }
        }

        function copyReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            
            navigator.clipboard.writeText(referralCode).then(() => {
                showToast('Referral code copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback
                const tempInput = document.createElement('input');
                tempInput.value = referralCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showToast('Referral code copied to clipboard!', 'success');
            });
        }

        function updateProfileUI(userData) {
            // Update form fields
            document.getElementById('fullName').value = userData.name || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('phone').value = userData.phone || '';
            document.getElementById('bankAccount').value = userData.bankAccount || '';
            document.getElementById('ifscCode').value = userData.ifsc || '';
            document.getElementById('upiId').value = userData.upi || '';
            document.getElementById('referredBy').value = userData.referredBy || 'No one';
            document.getElementById('lastUpdated').textContent = userData.updatedAt?.toDate ? 
                userData.updatedAt.toDate().toLocaleString() : 'Never';

            // Update profile pictures
            if (userData.profilePic) {
                document.getElementById('mainProfilePic').src = userData.profilePic;
                document.getElementById('userProfilePic').src = userData.profilePic;
                document.getElementById('headerProfilePic').src = userData.profilePic;
            }

            // Update status badges
            document.getElementById('membershipStatus').textContent = userData.membership || 'Starter';
            document.getElementById('kycStatus').textContent = userData.kycStatus || 'pending';
            document.getElementById('rankStatus').textContent = userData.rank || 'Affiliate';
            document.getElementById('referralCode').textContent = userData.referralCode || 'N/A';
            document.getElementById('joinDate').textContent = userData.joinDate?.toDate ? 
                userData.joinDate.toDate().toLocaleDateString('en-IN') : 'N/A';
            document.getElementById('lastLogin').textContent = userData.lastLogin?.toDate ? 
                userData.lastLogin.toDate().toLocaleDateString('en-IN') : 'N/A';

            // Update KYC status color
            const kycBadge = document.getElementById('kycStatus');
            if (userData.kycStatus === 'verified') {
                kycBadge.className = 'status-badge px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full';
            } else if (userData.kycStatus === 'pending') {
                kycBadge.className = 'status-badge px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full';
            }

            // Update sidebar
            updateUserUI(userData);
        }

        function loadNotifications(userId) {
            db.collection('notifications')
                .where('userId', '==', userId)
                .where('read', '==', false)
                .onSnapshot((snapshot) => {
                    const unreadCount = snapshot.size;
                    const badge = document.getElementById('notificationBadge');
                    
                    if (unreadCount > 0) {
                        badge.classList.remove('hidden');
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    } else {
                        badge.classList.add('hidden');
                    }
                });
        }

        function updateUserUI(userData) {
            document.getElementById('userName').textContent = userData.name || 'User';
            document.getElementById('headerUserName').textContent = userData.name || 'User';
            document.getElementById('userRank').textContent = userData.rank || 'Affiliate';
            document.getElementById('userBalance').textContent = userData.balance || 0;

            if (userData.profilePic) {
                document.getElementById('userProfilePic').src = userData.profilePic;
                document.getElementById('headerProfilePic').src = userData.profilePic;
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
  </html>
