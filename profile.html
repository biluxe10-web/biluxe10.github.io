<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile - Biluxe10</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:Poppins,system-ui;background:#071029;color:#e6eef8;margin:0;padding:20px}
.box{max-width:600px;margin:32px auto;background:#0b1220;padding:20px;border-radius:12px}
input,select{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #223}
.btn{background:linear-gradient(90deg,#f59e0b,#ff6b6b);border:none;color:#071029;padding:10px 14px;border-radius:8px;cursor:pointer}
.small{color:#98a0b3;font-size:13px}
</style>
</head>
<body>
<div class="box">
  <h2>Profile Settings</h2>
  <div class="small">Edit your details below</div>
  <input id="name" placeholder="Full name" />
  <input id="phone" placeholder="Phone number" />
  <input id="upi" placeholder="UPI ID (e.g. 9019254743@axl)" />
  <input id="crypto" placeholder="Crypto address (optional)" />
  <input type="file" id="pic" accept="image/*" />
  <button id="save" class="btn">Save Profile</button>
  <div id="msg" class="small"></div>
</div>

<script type="module">
import { auth, db, storage } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

const nameEl = document.getElementById('name'), phoneEl=document.getElementById('phone'), upiEl=document.getElementById('upi'), cryptoEl=document.getElementById('crypto'), picEl=document.getElementById('pic'), saveBtn=document.getElementById('save'), msg=document.getElementById('msg');

onAuthStateChanged(auth, async user=>{
  if(!user) { location.href='auth.html'; return; }
  const uid = user.uid;
  const dref = doc(db,'users',uid);
  let snap = await getDoc(dref);
  if(!snap.exists()){
    // try alternative collection name
    snap = await getDoc(doc(db,'Users_collection',uid));
  }
  const data = snap.exists()? snap.data() : {};
  nameEl.value = data.name||'';
  phoneEl.value = data.phone||'';
  upiEl.value = data.upi||'';
  cryptoEl.value = data.cryptoAddress||'';
});

saveBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if(!user) { location.href='auth.html'; return; }
  const uid = user.uid;
  const updates = { name: nameEl.value.trim(), phone: phoneEl.value.trim(), upi: upiEl.value.trim(), cryptoAddress: cryptoEl.value.trim() };

  // if file upload exists -> upload to storage then add profilePic URL
  const file = picEl.files[0];
  try {
    if(file){
      const stRef = ref(storage, `profile/${uid}_${Date.now()}`);
      const snap = await uploadBytes(stRef, file);
      const url = await getDownloadURL(snap.ref);
      updates.profilePic = url;
    }
    // update user doc
    // try both collections
    const uref = doc(db,'users',uid);
    await updateDoc(uref, updates).catch(async (e)=>{
      // fallback to Users_collection
      await updateDoc(doc(db,'Users_collection',uid), updates);
    });
    msg.textContent = "Profile updated successfully.";
  } catch(err){
    console.error(err);
    msg.textContent = "Update failed: "+err.message;
  }
});
</script>
</body>
  </html>
