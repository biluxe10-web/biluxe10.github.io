<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biluxe10 - Withdrawal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .page-transition { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .withdrawal-card { transition: all 0.3s ease; border-left: 4px solid; }
        .withdrawal-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-pending { border-left-color: #f59e0b; }
        .status-approved { border-left-color: #10b981; }
        .status-rejected { border-left-color: #ef4444; }
        .status-processing { border-left-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Sidebar (Same as dashboard) -->
    <div class="sidebar fixed left-0 top-0 h-full w-64 bg-gradient-to-b from-gray-900 to-black text-white shadow-xl z-50">
        <!-- Same sidebar code -->
    </div>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="flex items-center justify-between h-16 px-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Withdrawal Requests</h2>
                    <p class="text-sm text-gray-600">Request your earnings payout</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='notifications.html'" class="p-2 text-gray-600 hover:text-gray-900 relative">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notificationBadge" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <div class="flex items-center space-x-3 bg-gray-50 rounded-lg px-3 py-2 cursor-pointer" onclick="window.location.href='profile.html'">
                        <img id="headerProfilePic" src="https://via.placeholder.com/32" alt="Profile" class="w-8 h-8 rounded-full border-2 border-blue-500">
                        <span id="headerUserName" class="text-sm font-medium text-gray-900">User</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Withdrawal Content -->
        <main class="p-6 page-transition">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Withdrawal Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Request Withdrawal</h3>
                        
                        <!-- Balance Info -->
                        <div class="mb-6 p-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl text-white">
                            <div class="text-center">
                                <p class="text-sm opacity-90">Available Balance</p>
                                <p class="text-3xl font-bold mt-1">â‚¹<span id="availableBalance">0</span></p>
                                <p class="text-xs opacity-75 mt-1">Minimum withdrawal: â‚¹100</p>
                            </div>
                        </div>

                        <form id="withdrawalForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Amount (â‚¹) *
                                </label>
                                <input type="number" id="withdrawalAmount" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="Enter amount" min="100" step="100" required>
                                <p class="text-xs text-gray-500 mt-1">Minimum: â‚¹100 | Maximum: â‚¹<span id="maxAmount">0</span></p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Payment Method *
                                </label>
                                <select id="paymentMethod" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="UPI">UPI Transfer</option>
                                    <option value="Bank">Bank Transfer</option>
                                </select>
                            </div>

                            <!-- Account Details Display -->
                            <div id="accountDetails" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <p class="text-sm font-medium text-gray-700 mb-2">Payout to:</p>
                                <p id="accountInfo" class="text-sm text-gray-600">Loading account details...</p>
                                <p class="text-xs text-gray-500 mt-1">Update in Profile if needed</p>
                            </div>

                            <button type="submit" id="submitBtn" 
                                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                                Request Withdrawal
                            </button>
                        </form>

                        <!-- Processing State -->
                        <div id="processingState" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-center space-x-3">
                                <div class="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                <p class="text-blue-800 font-semibold">Processing your request...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Withdrawal Info -->
                    <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-2xl p-6">
                        <h4 class="font-semibold text-yellow-800 mb-3">ðŸ’¡ Withdrawal Information</h4>
                        <ul class="text-sm text-yellow-700 space-y-2">
                            <li>â€¢ Processing time: 24-48 hours</li>
                            <li>â€¢ Minimum withdrawal: â‚¹100</li>
                            <li>â€¢ No withdrawal fees</li>
                            <li>â€¢ Update bank/UPI details in Profile</li>
                            <li>â€¢ KYC verification required for large amounts</li>
                        </ul>
                    </div>
                </div>

                <!-- Withdrawal History -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Withdrawal History</h3>
                                    <p class="text-sm text-gray-600 mt-1">Your previous withdrawal requests</p>
                                </div>
                                <div class="flex items-center space-x-4 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                        <span>Pending: <span id="pendingCount">0</span></span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span>Approved: <span id="approvedCount">0</span></span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span>Processing: <span id="processingCount">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6">
                            <div id="withdrawalsList" class="space-y-4">
                                <div class="text-center py-12">
                                    <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                                    <p class="text-gray-500 text-lg">Loading withdrawal history...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase & Withdrawal Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDxxkC9iD1V1w-53Kf4oBrHEXlBLvCc7sE",
            authDomain: "biluxe10-3e894.firebaseapp.com",
            projectId: "biluxe10-3e894",
            storageBucket: "biluxe10-3e894.firebasestorage.app",
            messagingSenderId: "804749588233",
            appId: "1:804749588233:web:7777648c0c7834733c05d8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let withdrawals = [];

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            setupForm();
        });

        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    loadWithdrawals(user.uid);
                    loadNotifications(user.uid);
                } else {
                    window.location.href = 'auth.html';
                }
            });
        }

        function loadUserData(userId) {
            db.collection('users').doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    userData = doc.data();
                    updateUserUI(userData);
                    updateAccountDetails();
                    updateMaxAmount();
                }
            });
        }

        function loadWithdrawals(userId) {
            db.collection('withdrawals')
                .where('userId', '==', userId)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    withdrawals = [];
                    snapshot.forEach((doc) => {
                        withdrawals.push({ id: doc.id, ...doc.data() });
                    });
                    updateWithdrawalsUI();
                    updateStats();
                }, (error) => {
                    console.error('Error loading withdrawals:', error);
                });
        }

        function setupForm() {
            const form = document.getElementById('withdrawalForm');
            const amountInput = document.getElementById('withdrawalAmount');
            const methodSelect = document.getElementById('paymentMethod');

            form.addEventListener('submit', handleWithdrawalSubmit);
            methodSelect.addEventListener('change', updateAccountDetails);
            
            // Real-time amount validation
            amountInput.addEventListener('input', function() {
                validateAmount();
            });
        }

        function updateAccountDetails() {
            const method = document.getElementById('paymentMethod').value;
            const accountInfo = document.getElementById('accountInfo');

            if (!userData) {
                accountInfo.textContent = 'Loading account details...';
                return;
            }

            accountInfo.classList.remove('text-red-600');

            if (method === 'UPI') {
                if (userData.upi) {
                    accountInfo.textContent = `UPI: ${userData.upi}`;
                } else {
                    accountInfo.textContent = 'UPI ID not set. Please update in Profile.';
                    accountInfo.classList.add('text-red-600');
                }
            } else {
                if (userData.bankAccount && userData.ifsc) {
                    accountInfo.textContent = `Bank: ****${userData.bankAccount.slice(-4)} | IFSC: ${userData.ifsc}`;
                } else {
                    accountInfo.textContent = 'Bank details not set. Please update in Profile.';
                    accountInfo.classList.add('text-red-600');
                }
            }
        }

        function updateMaxAmount() {
            if (userData) {
                document.getElementById('maxAmount').textContent = userData.balance || 0;
            }
        }

        function validateAmount() {
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const submitBtn = document.getElementById('submitBtn');
            
            if (!amount || amount < 100) {
                submitBtn.disabled = true;
                return false;
            }

            if (amount > (userData?.balance || 0)) {
                submitBtn.disabled = true;
                return false;
            }

            submitBtn.disabled = false;
            return true;
        }

        async function handleWithdrawalSubmit(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const method = document.getElementById('paymentMethod').value;

            // Validation
            if (!validateAmount()) {
                alert('Please enter a valid amount between â‚¹100 and your available balance');
                return;
            }

            if ((method === 'UPI' && !userData.upi) || (method === 'Bank' && (!userData.bankAccount || !userData.ifsc))) {
                alert('Please set your payment details in Profile first');
                window.location.href = 'profile.html';
                return;
            }

            // Show processing state
            document.getElementById('processingState').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;

            try {
                const withdrawalId = generateId();
                
                // Create withdrawal request in Firestore
                await db.collection('withdrawals').doc(withdrawalId).set({
                    withdrawalId: withdrawalId,
                    userId: currentUser.uid,
                    userName: userData.name,
                    amount: amount,
                    method: method,
                    accountDetails: method === 'UPI' ? userData.upi : `Bank: ${userData.bankAccount} | IFSC: ${userData.ifsc}`,
                    status: 'pending',
                    createdAt: new Date(),
                    updatedAt: new Date()
                });

                // Create transaction record
                await db.collection('transactions').add({
                    transactionId: generateId(),
                    userId: currentUser.uid,
                    type: 'withdrawal',
                    amount: amount,
                    status: 'pending',
                    source: 'Withdrawal Request',
                    description: `Withdrawal request via ${method}`,
                    date: new Date()
                });

                // Update user balance
                const newBalance = (userData.balance || 0) - amount;
                await db.collection('users').doc(currentUser.uid).update({
                    balance: newBalance
                });

                // Create notification
                await db.collection('notifications').add({
                    userId: currentUser.uid,
                    title: 'Withdrawal Request Submitted',
                    message: `Your withdrawal request of â‚¹${amount} has been submitted and is under review.`,
                    type: 'withdrawal',
                    read: false,
                    createdAt: new Date()
                });

                // Reset form
                document.getElementById('withdrawalForm').reset();
                
                showSuccessMessage(`Withdrawal request of â‚¹${amount} submitted successfully! It will be processed within 24-48 hours.`);

            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                alert('Error submitting withdrawal request. Please try again.');
            } finally {
                document.getElementById('processingState').classList.add('hidden');
                document.getElementById('submitBtn').disabled = false;
            }
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg font-semibold z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        function updateWithdrawalsUI() {
            const container = document.getElementById('withdrawalsList');
            
            if (withdrawals.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl text-gray-300 mb-4">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <p class="text-gray-500 text-lg">No withdrawal requests yet</p>
                        <p class="text-sm text-gray-400">Your withdrawal history will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = withdrawals.map(withdrawal => `
                <div class="withdrawal-card bg-white rounded-lg shadow-sm p-6 border-l-4 status-${withdrawal.status}">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center ${
                                    withdrawal.status === 'approved' ? 'bg-green-100 text-green-600' :
                                    withdrawal.status === 'pending' ? 'bg-yellow-100 text-yellow-600' :
                                    withdrawal.status === 'processing' ? 'bg-blue-100 text-blue-600' :
                                    'bg-red-100 text-red-600'
                                }">
                                    <i class="fas ${
                                        withdrawal.status === 'approved' ? 'fa-check-circle' :
                                        withdrawal.status === 'pending' ? 'fa-clock' :
                                        withdrawal.status === 'processing' ? 'fa-sync-alt' :
                                        'fa-times-circle'
                                    }"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Withdrawal Request</p>
                                    <p class="text-sm text-gray-600">
                                        Method: ${withdrawal.method} | 
                                        ${withdrawal.createdAt?.toDate ? withdrawal.createdAt.toDate().toLocaleDateString('en-IN') : 'Recent'}
                                    </p>
                                    <p class="text-xs text-gray-500">ID: ${withdrawal.withdrawalId}</p>
                                    <p class="text-sm text-gray-700 mt-1">${withdrawal.accountDetails}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900 mb-2">â‚¹${withdrawal.amount.toLocaleString()}</p>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${
                                withdrawal.status === 'approved' ? 'bg-green-100 text-green-800' :
                                withdrawal.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                withdrawal.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${withdrawal.status.toUpperCase()}
                            </span>
                            ${withdrawal.approvedAt ? `
                                <p class="text-xs text-gray-500 mt-1">
                                    Processed: ${withdrawal.approvedAt.toDate().toLocaleDateString('en-IN')}
                                </p>
                            ` : ''}
                            ${withdrawal.adminNote ? `
                                <p class="text-xs text-gray-600 mt-1 max-w-xs">${withdrawal.adminNote}</p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const pending = withdrawals.filter(w => w.status === 'pending').length;
            const approved = withdrawals.filter(w => w.status === 'approved').length;
            const processing = withdrawals.filter(w => w.status === 'processing').length;
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('processingCount').textContent = processing;
        }

        function loadNotifications(userId) {
            db.collection('notifications')
                .where('userId', '==', userId)
                .where('read', '==', false)
                .onSnapshot((snapshot) => {
                    const unreadCount = snapshot.size;
                    const badge = document.getElementById('notificationBadge');
                    
                    if (unreadCount > 0) {
                        badge.classList.remove('hidden');
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    } else {
                        badge.classList.add('hidden');
                    }
                });
        }

        function updateUserUI(userData) {
            document.getElementById('userName').textContent = userData.name || 'User';
            document.getElementById('headerUserName').textContent = userData.name || 'User';
            document.getElementById('userRank').textContent = userData.rank || 'Affiliate';
            document.getElementById('userBalance').textContent = userData.balance || 0;
            document.getElementById('availableBalance').textContent = userData.balance || 0;

            if (userData.profilePic) {
                document.getElementById('userProfilePic').src = userData.profilePic;
                document.getElementById('headerProfilePic').src = userData.profilePic;
            }
        }

        // Utility function to generate IDs
        function generateId() {
            return 'WD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>
